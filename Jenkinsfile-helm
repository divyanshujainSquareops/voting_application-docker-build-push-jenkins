pipeline {
agent {
            kubernetes {
                yaml """
                apiVersion: v1
                kind: Pod
                metadata:
                    name: builder
                spec:
                  restartPolicy: Never
                  volumes:
                    - name: builder-storage
                      emptyDir: {}
                  containers:
                  - name: builder
                    image: squareops/jenkins-build-agent:v3
                    securityContext:
                      privileged: true
                    volumeMounts:
                      - name: builder-storage
                        mountPath: /var/lib/docker
                """
            }
        }

 
    stages {
        stage('Clone in Kaniko Container') {
           steps {
            script {
                container('builder') {
                    // Clone Git repo with credentials
                    git branch: 'main', credentialsId: 'github', url: 'https://github.com/divyanshujainSquareops/voting_application-helm-argocd.git'
                     withCredentials([usernamePassword(credentialsId: 'github', usernameVariable: 'USER_NAME', passwordVariable: 'PASSWORD')]) {
                        sh '''
                            cd ./worker/
                            yq e -i '.image.tag = "'$BUILD_NUMBER'"' values.yaml
                            cat values.yaml
                            cd ..

                            cd ./result/
                            yq e -i '.image.tag = "'$BUILD_NUMBER'"' values.yaml
                            cat values.yaml
                            cd ..

                            cd ./vote/
                            yq e -i '.image.tag = "'$BUILD_NUMBER'"' values.yaml
                            cat values.yaml
                            cd ..

                            ls -la
                            pwd
                            git config --global --add safe.directory /home/jenkins/agent/workspace/Voting-app-CI-CD
                            git config --global user.email "divyanshu.jain@squareops.com"
                            git config --global user.name "Divyanshu jain"
                            git add .
                            echo "BUILD_DATE: $BUILD_DATE"
                            git commit -m 'Docker Image version Update $JOB_NAME-$BUILD_NUMBER-$BUILD_DATE'

                            git push https://${USER_NAME}:${PASSWORD}@github.com/divyanshujainSquareops/voting_application-helm-argocd.git main
                        '''
                    }
                }
            }
        }
        }
    }
}
